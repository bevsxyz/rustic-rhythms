<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>WASM Quantized Matrix Processor</title>
  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen,
        Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background: #f5f7fa;
      margin: 0;
      padding: 2rem;
      display: flex;
      justify-content: center;
    }

    main {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.1);
      max-width: 400px;
      width: 100%;
    }

    h1 {
      margin-bottom: 1rem;
      font-weight: 600;
      text-align: center;
      color: #222;
    }

    label {
      display: block;
      font-weight: 600;
      margin-bottom: 0.25rem;
      color: #333;
    }

    input[type="number"] {
      width: 100%;
      padding: 0.5rem 0.75rem;
      font-size: 1rem;
      border-radius: 6px;
      border: 1.5px solid #ccc;
      transition: border-color 0.3s ease;
    }

    input[type="number"]:focus {
      outline: none;
      border-color: #0078d4;
      box-shadow: 0 0 5px rgba(0,120,212,0.3);
    }

    .input-error {
      border-color: #d93025;
    }

    .error-message {
      color: #d93025;
      font-size: 0.875rem;
      margin-top: 0.25rem;
    }

    button {
      margin-top: 1rem;
      width: 100%;
      padding: 0.75rem;
      background-color: #0078d4;
      border: none;
      border-radius: 6px;
      color: white;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      transition: background-color 0.3s ease;
      user-select: none;
    }

    button:disabled {
      background-color: #b0c9e8;
      cursor: not-allowed;
    }

    button:not(:disabled):hover {
      background-color: #005a9e;
    }

    #results {
      margin-top: 1.5rem;
      background: #f1f3f5;
      border-radius: 6px;
      padding: 1rem;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <main>
    <h1>Fetch Top 10 Songs from WASM</h1>
    <form id="songForm" onsubmit="return false;">
      <label for="songIdInput">Enter Song ID (0 - 75000):</label>
      <input 
        type="number" 
        id="songIdInput" 
        name="songIdInput" 
        min="0" max="75000" 
        required 
        autocomplete="off"
        aria-describedby="songIdError"
      />
      <div id="songIdError" class="error-message" role="alert" aria-live="polite"></div>
      <button id="runBtn" disabled>Run</button>
    </form>
    <div id="results" aria-live="polite" aria-atomic="true"></div>
  </main>

  <script type="module">
    import init, { process_quantized_msgpack, query_top_k_wasm } from "./pkg/rustic_rhythms.js";

    const songIdInput = document.getElementById("songIdInput");
    const runBtn = document.getElementById("runBtn");
    const resultsDiv = document.getElementById("results");
    const songIdError = document.getElementById("songIdError");

    // Initialize WASM module
    async function initializeWasm() {
      await init();
      // Enable input and button after WASM ready
      songIdInput.disabled = false;
      runBtn.disabled = true;
      try {
          const response = await fetch(
            "https://file-246a3f.gitlab.io/rustic-rhythms/quantized_weights_with_song_data.msgpack"
          );
          if (!response.ok)
            throw new Error(`HTTP error! status: ${response.status}`);
          const arrayBuffer = await response.arrayBuffer();
          const bytes = new Uint8Array(arrayBuffer);

          // Call your WASM function with binary data
          const joined = process_quantized_msgpack(bytes);
          //const array = joined.split(",");
          //output.textContent =
          //  "Dequantized first vector (f32 array slice):\n" + array;
        } catch (err) {
          console.log("Error processing file: " + err);
        }
    }
    initializeWasm();

    // Validate input and enable button
    function validateInput() {
      const val = parseInt(songIdInput.value, 10);
      if (isNaN(val) || val < 0 || val > 75000) {
        songIdInput.classList.add("input-error");
        songIdError.textContent = "Please enter a valid song ID between 0 and 75000.";
        runBtn.disabled = true;
      } else {
        songIdInput.classList.remove("input-error");
        songIdError.textContent = "";
        runBtn.disabled = false;
      }
    }

    songIdInput.addEventListener("input", () => {
      validateInput();
      resultsDiv.textContent = ""; // Clear previous results on input change
    });

    runBtn.addEventListener("click", async () => {
      const queryIndex = parseInt(songIdInput.value, 10);
      resultsDiv.textContent = "Loading top 10 songs...";
      try {
        const top10 = await query_top_k_wasm(queryIndex, 10);
        if (!Array.isArray(top10) || top10.length === 0) {
          resultsDiv.textContent = "No results found.";
          return;
        }
        // Clear previous results
        resultsDiv.innerHTML = "";
        top10.forEach(({ index, similarity }) => {
          const p = document.createElement("p");
          p.textContent = `Index: ${index}, Similarity: ${similarity.toFixed(4)}`;
          resultsDiv.appendChild(p);
        });
      } catch (err) {
        resultsDiv.textContent = "Error fetching top songs: " + err.message;
      }
    });

    // Disable input/button till WASM initialized
    songIdInput.disabled = true;
    runBtn.disabled = true;
  </script>
</body>
</html>

