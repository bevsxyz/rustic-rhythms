<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>WASM Quantized Matrix Processor</title>
  </head>
  <body>
    <h1>Upload Quantized Tensor MessagePack</h1>
    <input type="file" id="fileInput" />
    <button id="processBtn" disabled>Process File</button>
    <button id="queryBtn" disabled>Query ID</button>
    <pre id="output"></pre>
    <pre id="results"></pre>

    <script type="module">
      // Adjust './pkg/your_wasm_pkg.js' to your WASM pkg entry
      import init, {
        process_quantized_msgpack,
        query_top_k_wasm,
      } from "./pkg/rustic_rhythms.js";

      const fileInput = document.getElementById("fileInput");
      const processBtn = document.getElementById("processBtn");
      const queryBtn = document.getElementById("queryBtn");
      const output = document.getElementById("output");

      // Initialize WASM module
      async function run() {
        await init();
        processBtn.disabled = false;
        queryBtn.disabled = false;
      }

      async function getTopKSimilar(queryIndex, k) {
        try {
          // Call the WASM query function
          console.log("Ranssd")
          
          const resultsArray = query_top_k_wasm(queryIndex, k);
          // resultsArray is a JS Array of objects with { index, similarity }
          for (const result of resultsArray) {
            console.log(
              `Index: ${result.index}, Similarity: ${result.similarity}`
            );
          }

          return resultsArray;
        } catch (err) {
          console.error("Error querying top K similarity:", err);
        }
      }

      fileInput.addEventListener("change", () => {
        processBtn.disabled = !fileInput.files.length;
        output.textContent = "";
      });

      processBtn.addEventListener("click", () => {
        if (!fileInput.files.length) return;
        const file = fileInput.files[0];
        const reader = new FileReader();

        reader.onload = () => {
          const bytes = new Uint8Array(reader.result);
          try {
            // Call your WASM function with binary data
            const joined = process_quantized_msgpack(bytes);
            const array = joined.split(",");
            output.textContent =
              "Dequantized first vector (f32 array slice):\n" +
              array;
          } catch (err) {
            output.textContent = "Error processing file: " + err;
          }
        };

        queryBtn.addEventListener("click", async () => {
          const topK = await getTopKSimilar(2172, 100);
          const resultsDiv = document.getElementById("results");
          resultsDiv.innerHTML = ""; // Clear previous

          topK.forEach((res) => {
            const p = document.createElement("p");
            p.textContent = `Index: ${
              res.index
            }, Similarity: ${res.similarity.toFixed(4)}`;
            resultsDiv.appendChild(p);
          });
        });

        reader.readAsArrayBuffer(file);
      });

      run();
    </script>
  </body>
</html>
